<html><head><link rel="import" href="raml-js-parser-imports.html">

<script>!function(){"use strict";Polymer({is:"raml-js-parser",properties:{_eventTarget:{type:Object},ramlFile:Object,files:Array,latestResult:{type:Object,readOnly:!0,notify:!0},latestError:{type:Object,readOnly:!0,notify:!0},json:{type:Boolean,value:!1},latestJson:{type:Object,readOnly:!0,notify:!0},debug:Boolean},attached:function(){this._eventTarget=Polymer.dom(this).host||document,this.listen(this._eventTarget,"parse-raml-url","_parseRamlUrl"),this.listen(this._eventTarget,"parse-raml-content","_parseRamlContent"),this.listen(this._eventTarget,"parse-raml-file","_parseRamlFile")},detached:function(){this.unlisten(this._eventTarget,"parse-raml-url","_parseRamlUrl"),this.unlisten(this._eventTarget,"parse-raml-content","_parseRamlContent"),this.unlisten(this._eventTarget,"parse-raml-file","_parseRamlFile")},ready:function(){this.fire("raml-js-parser-ready")},_markTime:function(e){this.debug&&performance&&performance.mark&&performance.mark(e)},_parseRamlUrl:function(e){e.detail.url&&(e.stopImmediatePropagation(),e.detail.raml=this.loadApi(e.detail.url))},_parseRamlContent:function(e){e.detail.content&&(e.stopImmediatePropagation(),e.detail.files&&(this.files=e.detail.files),e.detail.raml=this.parseRaml(e.detail.content))},_parseRamlFile:function(e){e.detail.file&&(e.stopImmediatePropagation(),this.ramlFile=e.detail.file,e.detail.files&&(this.files=e.detail.files),e.detail.raml=this.loadFiles())},parseRaml:function(e){var t=this;return RAML.Parser.parseRAML(e,{fsResolver:{contentAsync:function(e){return t.contentAsync(e)}},httpResolver:{getResourceAsync:function(e){return t.getResourceAsync(e)}}}).then(function(e){return t.setApiData(e)}).catch(function(e){throw t._setLatestError(e),t.fire("error",{error:e}),e})},loadApi:function(e){this._markTime("load-raml-url-start");var t=this;return RAML.Parser.loadApi(e,{fsResolver:{contentAsync:function(e){return t.contentAsync(e)}},httpResolver:{getResourceAsync:function(e){return t.getResourceAsync(e)}}}).then(function(e){return t._markTime("load-raml-url-end"),t.setApiData(e)}).catch(function(e){throw t._markTime("load-raml-url-end"),t._setLatestError(e),t.fire("error",{error:e}),e}).then(function(e){return t._measureData(),e})},setApiData:function(e){var t,r={result:e};return this.json&&(t=e.expand(!0).toJSON({dumpSchemaContents:!1,rootNodeDetails:!0,serializeMetadata:!1}),r.json=t),this._setLatestJson(t),this._setLatestResult(e),this.fire("api-parse-ready",r),r},contentAsync:function(e){return new Promise(function(t,r){this.findEntry(e).then(function(n){if(!n)return void r(new Error("Entry not found."));var i;n.isFile?n.file(function(e){i=new FileReader,i.addEventListener("loadend",function(e){t(e.target.result)}),i.addEventListener("error",function(e){r(e)}),i.readAsText(e)}):n.isDirectory?r(new Error("File entry for "+e+" do not exists.")):(i=new FileReader,i.addEventListener("loadend",function(e){t(e.target.result)}),i.addEventListener("error",function(e){r(e)}),i.readAsText(n))}).catch(function(e){r(e)})}.bind(this))},getResourceAsync:function(e){this._markTime("raml-file-fetch-start");var t=this;return fetch(e).then(function(e){return t._markTime("raml-file-fetch-end"),e.text()}).then(function(e){return{content:e}})},loadFiles:function(){var e=this;return new Promise(function(t,r){if(!e.ramlFile)return void r(new Error("No file entry available"));var n;e.ramlFile.isFile?e.ramlFile.file(function(i){n=new FileReader,n.addEventListener("loadend",function(r){t(e.parseRaml(r.target.result))}),n.addEventListener("error",function(e){r(e)}),n.readAsText(i)}):e.ramlFile.isDirectory||(n=new FileReader,n.addEventListener("loadend",function(r){t(e.parseRaml(r.target.result))}),n.addEventListener("error",function(e){r(e)}),n.readAsText(e.ramlFile))})},findEntry:function(e){var t=this.files;return!t||1===t.length&&t[0]===this.ramlFile?Promise.resolve(null):new Promise(function(r){for(var n=0,i=t.length;n<i;n++){var a=t[n];if(!a.isDirectory&&a.fullPath===e)return void r(a)}var s=[];t.forEach(function(t){t.isDirectory&&s.push(this._processEntryPath(t,e))},this),Promise.all(s).then(function(e){if(e=e.filter(function(e){return!!e}),e.length>0)return void r(e[0]);r(null)})}.bind(this))},_processEntryPath:function(e,t){if(e.isDirectory){var r=this;return new Promise(function(n,i){var a=e.createReader(),s=[],o=function(){a.readEntries(function(e){r._readDirectoryEntries(e,s,t)?o():Promise.all(s).then(function(e){var t=r._cleanUpCandidates(e);n(t)}).catch(i)},i)};o()})}return e.fullPath===t?Promise.resolve(e):e.fullPath.substr(e.fullPath.indexOf("/",1))===t?Promise.resolve(e):Promise.resolve(null)},_readDirectoryEntries:function(e,t,r){if(e.length){for(var n=0,i=e.length;n<i;n++)t.push(this._processEntryPath(e[n],r));return!0}return!1},_cleanUpCandidates:function(e){e=e.filter(function(e){return!!e});var t=e.length;if(0===t)return null;for(var r=0;r<t;r++){var n=e[r];if(!(n instanceof Array))return n;if(n.length>0)return n[0]}},_measureData:function(){if(this.debug&&performance&&performance.mark){performance.measure("api-spec-load-time","load-raml-url-start","load-raml-url-end");var e=window.performance.getEntriesByType("measure");console.log(e)}}})}();</script>
</head><body></body></html>