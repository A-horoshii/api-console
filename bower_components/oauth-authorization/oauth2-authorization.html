<html><head><link rel="import" href="../polymer/polymer.html">

<script>Polymer({is:"oauth2-authorization",properties:{tokenInfo:{type:Object,readOnly:!0}},attached:function(){this.listen(window,"oauth2-token-requested","_tokenRequestedHandler"),this.listen(window,"message","_listenPopup")},detached:function(){this.unlisten(window,"oauth2-token-requested","_tokenRequestedHandler"),this.unlisten(window,"message","_listenPopup")},clear:function(){this._popup=void 0,this._state=void 0},_tokenRequestedHandler:function(e,t){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this._eventSource=e.target,this.authorize(t)},authorize:function(e){switch(this._setTokenInfo(void 0),this._type=e.type,e.type){case"implicit":this._authorizeToken(e);break;case"authorization_code":this._authorizeCode(e);break;case"client_credentials":this._authorizeClientCredential(e);break;case"password":this._authorizePassword(e);break;default:throw new Error("Unknown authorization method "+e.type)}},_authorizeToken:function(e){var t=this._constructPopupUrl(e,"token");if(this._popup=window.open(t,"oauth-window","menubar=no,location=no,resizable=yes,scrollbars=yes,status=no,width=800,height=600"),!this._popup)return void this.fire("oauth2-error",{message:"Authorization popup is being blocked.",code:"popup_blocked"});this._popup.window.focus(),this._observePopupState()},_authorizeCode:function(e){this._settings=e;var t=this._constructPopupUrl(e,"code");if(this._popup=window.open(t,"oauth-window-code","menubar=no,location=no,resizable=yes,scrollbars=yes,status=no,width=800,height=600"),!this._popup)return void this.fire("oauth2-error",{message:"Authorization popup is being blocked.",code:"popup_blocked"});this._popup.window.focus(),this._observePopupState()},_observePopupState:function(){var e=this,t=setInterval(function(){e._popup&&!e._popup.closed||(clearInterval(t),e._beforePopupUnloadHandler())},500)},_constructPopupUrl:function(e,t){this._state=this.randomString(6);var o=e.authorizationUrl+"?response_type="+t+"&";return o+="client_id="+encodeURIComponent(e.clientId)+"&",e.redirectUrl&&(o+="redirect_uri="+encodeURIComponent(e.redirectUrl)+"&"),o+="scope="+encodeURIComponent(e.scopes.join(" ")),o+="&state="+encodeURIComponent(this._state)},_listenPopup:function(e){if(location&&e.source&&this._popup&&e.origin===location.origin&&e.source.location.href===this._popup.location.href){var t=e.data;if(t.state!==this._state)return this.clear(),this._eventSource=void 0,void this.fire("oauth2-error",{message:"Invalid state returned by the oauth server.",code:"invalid_state"});"error"in t?this.fire("oauth2-error",{message:t.errorDescription||"The request is invalid.",code:t.error}):"implicit"===this._type?(this._setTokenInfo(t),this._eventSource&&(this._eventSource.tokenValue=t.accessToken),this.fire("oauth2-token-response",t),this._eventSource=void 0):"authorization_code"===this._type&&(this._exchangeCodeValue=t.code,this._exchangeCode(t.code)),this._popup.close(),this.clear()}},randomString:function(e){return Math.round(Math.pow(36,e+1)-Math.random()*Math.pow(36,e)).toString(36).slice(1)},_beforePopupUnloadHandler:function(){this.tokenInfo||"authorization_code"===this._type&&this._exchangeCodeValue||(this.clear(),this._eventSource=void 0,this.fire("oauth2-error",{message:"No response has been recorded.",code:"no_response"}))},_exchangeCode:function(e){var t=this._settings.accessTokenUrl,o=this._getCodeEchangeBody(this._settings,e);this._tokenCodeRequest(t,o)},_getCodeEchangeBody:function(e,t){var o="grant_type=authorization_code&";return o+="client_id="+encodeURIComponent(e.clientId)+"&",e.redirectUrl&&(o+="redirect_uri="+encodeURIComponent(e.redirectUrl)+"&"),o+="code="+encodeURIComponent(t)+"&",o+="client_secret="+e.clientSecret},_tokenCodeRequest:function(e,t){var o=new XMLHttpRequest;o.addEventListener("load",function(e){try{this._handleTokenCodeResponse(e.target.response,e.target.getResponseHeader("content-type"))}catch(e){this.fire("oauth2-error",{message:e.message||"App error while decoding the token.",code:0})}}.bind(this)),o.addEventListener("error",this._handleTokenCodeError.bind(this)),o.open("POST",e),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(t)},_handleTokenCodeResponse:function(e,t){var o;if(-1!==t.indexOf("json"))try{o=JSON.parse(e);for(var n in o){var s=this._camel(n);s&&(o[s]=o[n])}}catch(e){return this.fire("oauth2-error",{message:"The response could not be parsed. "+e.message,code:"response_parse"}),this._settings=void 0,this._eventSource=void 0,void(this._exchangeCodeValue=void 0)}else o={},e.split("&").forEach(function(e){var t=e.split("="),n=t[0],s=this._camel(n),i=decodeURIComponent(t[1]);o[n]=i,o[s]=i},this);this._setTokenInfo(o),"error"in o?this.fire("oauth2-error",{message:o.errorDescription||"The request is invalid.",code:o.error}):(this._eventSource&&(this._eventSource.tokenValue=o.accessToken),this.fire("oauth2-token-response",o)),this._settings=void 0,this._eventSource=void 0,this._exchangeCodeValue=void 0},_handleTokenCodeError:function(e){this.fire("oauth2-error",{message:"Couldn't connect to the server. "+e.message,code:"request_error"}),this._settings=void 0,this._eventSource=void 0},_camel:function(e){for(var t,o=0,n=!1;t=e[o];)("_"===t||"-"===t)&&o+1<e.length&&(e=e.substr(0,o)+e[o+1].toUpperCase()+e.substr(o+2),n=!0),o++;return n?e:void 0},_authorizePassword:function(e){var t=this._settings.accessTokenUrl,o=this._getPasswordBody(e),n=new XMLHttpRequest;n.addEventListener("load",function(e){try{this._handleTokenCodeResponse(e.target.response,e.target.getResponseHeader("content-type"))}catch(e){this.fire("oauth2-error",{message:e.message||"App error while decoding the token.",code:0})}}.bind(this)),n.addEventListener("error",this._handleTokenCodeError.bind(this)),n.open("POST",t),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(o)},_getPasswordBody:function(e){var t="grant_type=password";return t+="&username="+encodeURIComponent(e.username),t+="&password="+encodeURIComponent(e.password),e.clientId&&(t+="&client_id="+encodeURIComponent(e.clientId)),e.scopes&&e.scopes.length&&(t+="scope="+encodeURIComponent(e.scopes.join(" "))),t},_authorizeClientCredential:function(e){var t=this._settings.accessTokenUrl,o=this._getClientCredentialBody(e),n=new XMLHttpRequest;n.addEventListener("load",function(e){try{this._handleTokenCodeResponse(e.target.response,e.target.getResponseHeader("content-type"))}catch(e){this.fire("oauth2-error",{message:e.message||"App error while decoding the token.",code:0})}}.bind(this)),n.addEventListener("error",this._handleTokenCodeError.bind(this)),n.open("POST",t),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(o)},_getClientCredentialBody:function(e){var t="grant_type=client_credentials";return e.clientId&&(t+="&client_id="+encodeURIComponent(e.clientId)),e.clientSecret&&(t+="&client_secret="+e.clientSecret),e.scopes&&e.scopes.length&&(t+="scope="+encodeURIComponent(e.scopes.join(" "))),t}});</script>
</head><body></body></html>