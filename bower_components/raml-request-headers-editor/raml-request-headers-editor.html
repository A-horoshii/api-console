<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../headers-parser-behavior/headers-parser-behavior.html">
<link rel="import" href="../raml-headers-form/raml-headers-form.html">
<link rel="import" href="../code-mirror/code-mirror.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../arc-icons/arc-icons.html">

<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="cm-arc-styles.html">
<link rel="import" href="cm-modules-import.html">

</head><body><dom-module id="raml-request-headers-editor">
  <template>
    <style>
     :host {
      display: block;
      position: relative;

      @apply(--raml-request-headers-editor);

      --code-mirror-editor: {
        z-index: 0;
      }

      --paper-autocomplete: {
        top: 32px;
      }
    }
    .CodeMirror-hints {
      position: absolute;
      z-index: 10;
      background: white;
      overflow: hidden;
      overflow-y: auto;
      max-height: 20em;
      margin-left: 20px;
    }

    .editor-actions {
      padding: 0 8px;
    }

    #copyContainer {
      margin: 0;
      padding: 0;
    }

    paper-icon-button[active] {
      background-color: #E0E0E0;
      border-radius: 50%;
    }
    </style>
    <div class="content">
      <div class="editor-actions">
        <paper-icon-button icon="arc:content-copy" id="copyButton" on-tap="_copyToClipboard"></paper-icon-button>
        <paper-icon-button icon="arc:code" id="editMode" toggles="" active="{{sourceMode}}"></paper-icon-button>
        <paper-tooltip for="copyButton">Copy headers value to clipboard</paper-tooltip>
        <paper-tooltip for="editMode">Toggle source edit mode</paper-tooltip>
      </div>
      <iron-pages content="" selected="{{selected}}" on-iron-select="_tabChangedHandler" selected-attribute="active">
        <raml-headers-form value="{{value}}" narrow="[[narrow]]" narrow-width="[[narrowWidth]]" raml-headers="[[ramlHeaders]]"></raml-headers-form>
        <code-mirror mode="http-headers" theme="cm-arc" value="{{value}}"></code-mirror>
      </iron-pages>
    </div>
    <p id="copyContainer"></p>
  </template>
  <script>Polymer({is:"raml-request-headers-editor",behaviors:[ArcBehaviors.HeadersParserBehavior],properties:{value:{type:String,notify:!0},selected:{type:Number,value:0},ramlHeaders:Object,contentType:{type:String,notify:!0,observer:"_onContentTypeChanged"},narrow:{type:Boolean,value:!1,notify:!0},narrowWidth:{type:String,value:"768px"},sourceMode:Boolean},observers:["_valueChanged(value)","_sourceModeChanged(sourceMode)"],attached:function(){this.listen(window,"request-headers-changed","_headersChangedHandler"),this.listen(window,"request-header-changed","_headerChangedHandler")},detached:function(){this.unlisten(window,"request-headers-changed","_headersChangedHandler"),this.unlisten(window,"request-header-changed","_headerChangedHandler")},ready:function(){var e=this.$$("code-mirror");e.setOption("extraKeys",{"Ctrl-Space":function(e){CodeMirror.showHint(e,CodeMirror.hint["http-headers"],{container:Polymer.dom(this.root)})}.bind(this)})},_sourceModeChanged:function(e){e?this.set("selected",1):this.set("selected",0)},_valueChanged:function(e){this._detectContentType(e),this._cacncelChangeEvent||this.fire("request-headers-changed",{value:e})},_detectContentType:function(e){if(!e&&this.contentType)return void this.set("contentType",null);if(this.value){var t=this.getContentType(e);t&&this.set("contentType",t)}},_onContentTypeChanged:function(e){if(!e)return void this.fire("content-type-changed",{value:""});var t=this.headersToJSON(this.value),n=!1,a=!1;if(t.map(function(t){return n||"content-type"!==t.name.toLowerCase()?t:(n=!0,t.value===e?(a=!0,t):(t.value=e,t))}),!a){n||t.push({name:"Content-Type",value:e});var r=this.headersToString(t);this.set("value",r),this.fire("content-type-changed",{value:e})}},_tabChangedHandler:function(e){var t=e.detail.item&&e.detail.item.nodeName;t&&"CODE-MIRROR"===t&&e.detail.item.editor.refresh()},_copyToClipboard:function(){this.$.copyContainer.innerText=this.value;var e=document.createRange();e.selectNodeContents(this.$.copyContainer);var t=window.getSelection();t.removeAllRanges(),t.addRange(e);var n=!1;try{n=document.execCommand("copy"),this.$.copyButton.icon="arc:done"}catch(e){Polymer.Base._error(e),this.$.copyButton.icon="arc:error"}return this.$.copyContainer.innerText="",setTimeout(this._resetCopyButtonState.bind(this),1e3),t.removeAllRanges(),n},_resetCopyButtonState:function(){this.$.copyButton.icon="arc:content-copy"},_headersChangedHandler:function(e){if(e.target!==this&&!e.defaultPrevented){var t=e.detail.value;this._cacncelChangeEvent=!0,this.set("value",t),this._cacncelChangeEvent=!1}},_headerChangedHandler:function(e){if(!e.defaultPrevented){var t=e.detail.name;if(!t)return console.warn("request-header-changed fired without the name.");for(var n=e.detail.value,a=this.headersToJSON(this.value),r=!1,o=0,i=a.length;o<i;o++)if(a[o].name.toLowerCase()===t.toLowerCase()){a[o].value=n,r=!0;break}r||a.push({name:t,value:n});var s=this.headersToString(a);this._cacncelChangeEvent=!0,this.set("value",s),this._cacncelChangeEvent=!1}}});</script>
</dom-module>
</body></html>