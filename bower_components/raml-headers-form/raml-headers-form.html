<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../arc-definitions/arc-definitions.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-input/paper-input-error.html">
<link rel="import" href="../headers-parser-behavior/headers-parser-behavior.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../markdown-styles/markdown-styles.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">


</head><body><dom-module id="raml-headers-form">
  <template>
    <style include="markdown-styles"></style>
    <style>
     :host {

      display: block;

      @apply(--raml-headers-form);

      --paper-input-container-label: {
        color: var(--raml-headers-form-input-label-color, rgba(0, 0, 0, 0.48));
      }
    }

    .required paper-input {
      --paper-input-container-label: {
        color: var(--raml-request-parameters-editor-required-input-label-color, rgba(0, 0, 0, 0.72));
      }
    }

    .header-value {
      @apply(--raml-request-parameters-editor-row);
      position: relative;
    }

    .header-value .input {
      @apply(--layout-horizontal);
      @apply(--layout-flex);
    }

    .docs {
      @apply(--paper-font-common-base);
      font-size: 13px !important;
      font-weight: 200;
      line-height: 24px;
      color: var(--inline-documentation-color, rgba(0, 0, 0, 0.87));
    }

    .markdown-html * {
      font-size: 13px !important;
    }

    .markdown-html p:first-child {
      margin-top: 0;
      padding-top: 0;
    }

    .markdown-html p:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .help-icon {
      color: rgba(0, 0, 0, 0.12);
      transition: color 0.2s linear;
    }

    .help-icon:hover {
      color: var(--accent-color, rgba(0, 0, 0, 0.74));
    }

    .value-input {
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--layout-flex);
    }

    .value-input paper-dropdown-menu,
    .value-input paper-input {
      @apply(--layout-flex);
    }

    .header-name {
      margin-right: 8px;
    }

    .action-button {
      color: var(--accent-color);
      background-color: #fff;
    }
    </style>
    <iron-media-query query="(max-width: [[narrowWidth]])" query-matches="{{narrow}}"></iron-media-query>

    <form is="iron-form" id="form">
      <template is="dom-repeat" items="{{renderedRamlHeaders}}" id="headersList">
        <div class$="[[_computeRowClass(item)]]">
          <div class="value-input">
            <template is="dom-if" if="[[_computeIsEnum(item.enum)]]">
              <paper-dropdown-menu label="[[_computeInputLabel(item.*)]]" name="[[item.name]]" required="" id="rrpv-[[index]]">
                <paper-listbox class="dropdown-content" attr-for-selected="data-value" selected="{{item.value}}">
                  <template is="dom-repeat" items="[[item.enum]]">
                    <paper-item data-value="[[item]]">[[item]]</paper-item>
                  </template>
                  <paper-item label=" ">(empty value)</paper-item>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-icon-button title="Display documentation" class="help-icon" suffix="" icon="arc:help" hidden$="[[!hasValue(item.description)]]" on-tap="_openDocs"></paper-icon-button>
            </template>
            <template is="dom-if" if="[[!_computeIsEnum(item.enum)]]">
              <div class="input">
                <template is="dom-if" if="[[!_hasName(item.*)]]">
                  
                  <paper-input-container class="header-name" auto-validate="">
                    <label>Header name</label>
                    <input is="iron-input" class="name-change-input" on-focus="_headerNameFocus" type="text" value="{{item.name::input}}" required="" pattern="\S*" on-change="_headerNameChanged">
                    <paper-input-error>Header name is not valid</paper-input-error>
                  </paper-input-container>
                </template>
                <paper-input label="[[_computeInputLabel(item.*)]]" id="rrpv-[[index]]" value="{{item.value}}" required="[[item.required]]" pattern="[[item.pattern]]" name="[[item.name]]" auto-validate="" type="[[_computeInputType(item.type)]]" min="[[item.minimum]]" max="[[item.maximum]]" maxlength="[[item.maxLength]]" always-float-label="[[_computeFloatLabel(item.*)]]" placeholder="[[_computePlacdeholder(item.*)]]">
                </paper-input>
              </div>
              <paper-icon-button title="Remove header" class="delete-icon" suffix="" icon="arc:close" hidden$="[[!hasValue(item.customHeader)]]" on-tap="_removeHeader"></paper-icon-button>
              <paper-icon-button title="Display documentation" class="help-icon" suffix="" icon="arc:help" hidden$="[[!hasValue(item.description)]]" on-tap="_openDocs"></paper-icon-button>
            </template>
          </div>
          <div class="docs" hidden$="[[!hasValue(item.description)]]">
            <iron-collapse>
              <marked-element markdown="[[item.description]]">
                <div class="markdown-html markdown-body"></div>
              </marked-element>
            </iron-collapse>
          </div>
          <paper-autocomplete open-on-focus="" on-query="_queryHeaderName" on-selected="_onHeaderNameSelected"></paper-autocomplete>
        </div>
      </template>
    </form>
    <div class="add-action">
      <paper-button class="action-button" on-tap="add">add custom header</paper-button>
    </div>
    <arc-definitions></arc-definitions>
  </template>
  <script>Polymer({is:"raml-headers-form",behaviors:[ArcBehaviors.HeadersParserBehavior],properties:{ramlHeaders:Array,renderedRamlHeaders:{type:Array,value:function(){return[]},computed:"_computeRenderedRamlHeaders(ramlHeaders.*)"},activeHeaderNameField:{type:HTMLElement,readOnly:!0},activeAutocompleteNameField:{type:HTMLElement,readOnly:!0},value:{type:String,value:"",notify:!0},narrow:{type:Boolean,value:!1,notify:!0,reflectToAttribute:!0},narrowWidth:{type:String,value:"768px"},_eventTarget:HTMLElement},observers:["_renderedRamlHeaders(renderedRamlHeaders.*)","_valueChanged(value)"],attached:function(){this._eventTarget=Polymer.dom(this).host||document,this.listen(this._eventTarget,"headers-value-changed","_extValueChangedHandler")},detached:function(){this._eventTarget&&this.unlisten(this._eventTarget,"headers-value-changed","_extValueChangedHandler")},_computeRenderedRamlHeaders:function(e){var a=e&&e.base;return a&&a.length?this._transformHeaders(a):[]},_transformHeaders:function(e){return e.map(function(e){return e=Object.assign({},e),e.required&&"undefined"!=typeof e.default&&!e.value&&(e.value=e.default),"undefined"==typeof e.value&&e.required&&(e.examples?e.value=e.examples[0]:e.example&&(e.value=e.example),e.value&&e.value.indexOf&&0===e.value.indexOf(e.name+":")&&(e.value=e.value.substr(e.name.length+1)),"undefined"==typeof e.value&&e.enum&&e.enum.length&&(e.value=e.enum[0])),e})},_computeInputLabel:function(e){var a=e&&e.base;if(!a)return"Header value";if(a.customHeader)return"Header value";var r=a.displayName||a.name;return r?(a.required&&(r+="*"),r):"Header value"},_computeInputType:function(e){if(!e||"text"===e)return"text";switch(e){case"number":case"integer":case"float":return"number";default:return"text"}},_removeHeader:function(e){if(e.model){var a=e.model.get("index");a<0||this.splice("renderedRamlHeaders",a,1)}},add:function(){var e={type:"string",value:"",name:"",customHeader:!0};this.renderedRamlHeaders?this.push("renderedRamlHeaders",e):this.set("renderedRamlHeaders",[e])},_hasName:function(e){var a=e.base;return!!a&&(!!a.name&&!a.customHeader)},_headerNameFocus:function(e){var a=this.$.headersList.indexForElement(e.target);if(!(void 0===a||a<0)){var r=Polymer.dom(this.root).querySelector(".header-value:nth-child("+(a+1)+") paper-autocomplete");if(!r)return void console.warn("Autocomplete element not found.");r.target=e.target,this._setActiveHeaderNameField(e.target),this._setActiveAutocompleteNameField(r)}},_onHeaderNameSelected:function(e){var a=e.model.get("index");if(a||0===a){this.set(["renderedRamlHeaders",a,"name"],e.detail.value);var r=Polymer.dom(this.root).querySelector(".header-value:nth-child("+(a+1)+") .name-change-input");r&&r.fire("bind-value-changed"),this._queryHeaderInfo(e.detail.value)||(this.set(["renderedRamlHeaders",a,"description"],""),this.set(["renderedRamlHeaders",a,"examples"],[""]))}},_headerNameChanged:function(e){if(e.model){var a=e.model.get("item"),r=this.$.headersList.indexForElement(e.target);if(r){if(a.name)return void(this._queryHeaderInfo(a.name)||(this.set(["renderedRamlHeaders",r,"description"],""),this.set(["renderedRamlHeaders",r,"examples"],[""])));this.set(["renderedRamlHeaders",r,"description"],""),this.set(["renderedRamlHeaders",r,"examples"],[""])}}},_queryHeaderInfo:function(e){var a,r,t,n=this._queryHeaderNameSuggestions(e);if(n&&n.length)for(r=0,t=n.length;r<t;r++)if(n[r].key===e){a=n[r];break}if(!a)return!1;var d,i=this.renderedRamlHeaders;for(r=0,t=i.length;r<t;r++)if(i[r].name===e){d=r;break}return void 0!==d&&(this.set(["renderedRamlHeaders",d,"description"],a.desc),this.set(["renderedRamlHeaders",d,"examples"],[a.example]),!0)},_queryHeaderName:function(e){if(this.activeAutocompleteNameField){var a=e.detail.value;if(!a){var r=this.$$("arc-definitions");return void(r&&r.requestHeaders?this.activeAutocompleteNameField.source=r.requestHeaders.map(function(e){return e.key}):this.activeAutocompleteNameField.source=[])}var t=this._queryHeaderNameSuggestions(a);return t&&t.length?void(this.activeAutocompleteNameField.source=t.map(function(e){return{value:e.key,display:e.key}})):void(this.activeAutocompleteNameField.source=[])}},_queryHeaderNameSuggestions:function(e){var a=this.fire("query-headers",{type:"request",query:e});return a.detail.headers},_renderedRamlHeaders:function(e){this._internalValueChange||("renderedRamlHeaders"===e.path?this._updateValue():e.path.match(/renderedRamlHeaders.#\d+.(name|value)/)?this._updateValue():"renderedRamlHeaders.splices"===e.path&&this._updateValue())},_updateValue:function(){var e=this.renderedRamlHeaders;if(!e||!e.length)return void(this.value="");var a=e.map(function(e){var a=e.name||"",r=e.value||"";if(a||r)return a+": "+r}).filter(function(e){return!!e}).join("\n");this._internalValueChange=!0,this.set("value",a),this._internalValueChange=!1},_valueChanged:function(e){if(this._internalValueChange)return void this.fire("headers-value-changed",{value:e});var a=this.headersToJSON(e);if(a&&a.length){var r,t,n=this.renderedRamlHeaders;if(this._internalValueChange=!0,n&&n.length){var d=n.length;for(r=0,t=a.length;r<t;r++){for(var i=!1,l=0;l<d;l++)if(a[r].name===n[l].name){i=!0,this.set(["renderedRamlHeaders",l,"value"],a[r].value);break}i||this.push("renderedRamlHeaders",this._headersModelFromObject(a[r]))}var s=a.map(function(e){return e.name});for(r=n.length-1;r>=0;r--)s.indexOf(n[r].name)===-1&&this.splice("renderedRamlHeaders",r,1)}else for(r=0,t=a.length;r<t;r++)this.push("renderedRamlHeaders",this._headersModelFromObject(a[r]));this._internalValueChange=!1}},_headersModelFromObject:function(e){return{key:e.name,name:e.name,required:!1,type:"string",value:e.value,customHeader:!0}},_extValueChangedHandler:function(e){e.target!==this&&this.set("value",e.detail.value)},_getValidity:function(){return this.$.form.validate()},hasValue:function(e){return"number"==typeof e&&0===e||("boolean"==typeof e||!!e)},isDisplayHelpHidden:function(e){var a=e.base;return!a||(!a.description||!a.name)},_openDocs:function(e){var a=e.model,r=this.$.form.querySelector(".header-value:nth-child("+(a.index+1)+") iron-collapse");r&&(r.opened=!r.opened)},_computePlacdeholder:function(e){var a=e.base;if(a)return a.examples&&a.examples.length&&a.examples[0]?"Example: "+a.examples[0]:void 0},_computeFloatLabel:function(e){var a=this._computePlacdeholder(e);return!!a},_computeRowClass:function(e){var a="header-value";return a+=e.required?" required":" optional"},_computeIsEnum:function(e){return!(!e||!e.length)}});</script>
</dom-module>
</body></html>