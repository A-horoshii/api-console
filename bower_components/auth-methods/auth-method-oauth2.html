<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-masked-input/paper-masked-input.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../oauth2-scope-selector/oauth2-scope-selector.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="polyfills.html">
<link rel="import" href="auth-methods-behavior.html">

</head><body><dom-module id="auth-method-oauth2">
  <template>
    <style include="auth-methods-styles">
    :host {
      display: block;
      @apply(--auth-method-panel);
      @apply(--auth-method-oauth2);

      --paper-icon-button: {
        color: var(--hint-trigger-color, rgba(0, 0, 0, 0.54));
        transition: color 0.25s linear;
        @apply(--icon-button);
      }

      --paper-icon-button-hover: {
        color: var(--hint-trigger-hover-color, rgba(0, 0, 0, 0.78));
        @apply(--icon-button-hover);
      }
    }

    .form-panel {
      @apply(--layout-horizontal);
    }

    .form {
      @apply(--layout-flex);
      max-width: 700px;
    }

    oauth2-scope-selector {
      margin: 24px 0;
      outline: none;

    }

    .grant-dropdown {
      width: 320px;
    }

    .next-button,
    .auth-button {
      color: var(--accent-color);
      background-color: #fff;
    }

    .auth-button[disabled] {
      background-color: rgba(0, 0, 0, 0.24);
      color: rgba(0, 0, 0, 0.54);
    }

    .authorize-actions {
      margin-top: 12px;
    }

    .read-only-param-field {
      background-color: rgba(0, 0, 0, 0.12);
      @apply(--arc-font-body1);
      display: block;
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-all;
      @apply(--layout-horizontal);
    }

    .read-only-param-field.padding {
      padding: 12px;
    }

    .read-only-param-field.no-background {
      background-color: transparent;
    }

    .current-token {
      margin-top: 24px;
    }

    .top-line {
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }

    .enable-container {
      @apply(--layout-flex);
    }

    label {
      @apply(--form-label);
    }

    .token-info,
    .redirect-info {
      @apply(--arc-font-body1);
      font-weight: 200;
      color: rgba(0, 0, 0, 0.54);
    }

    .code {
      font-family: 'Roboto Mono', 'Consolas', 'Menlo', monospace;
      -webkit-font-smoothing: antialiased;
      @apply(--arc-font-code1);
      @apply(--layout-flex);
    }

    .token-label {
      font-weight: 500;
      font-size: 16px;
    }

    .current-token {
      padding: 12px;
      border: 2px #3D8099 solid;
    }

    .current-token,
    .redirect-section,
    oauth2-scope-selector {
      max-width: 560px;
      width: calc(100% - 16px);
      box-sizing: border-box;
    }
    </style>
    <form is="iron-form" id="form">
      <div class="row">
        <div class$="[[_computeStepperClass(isSelectedType)]]" on-tap="_clearTypeSelection">
          <span class="step">[[_computeStep(stepStartIndex, 1)]]</span>
          <span class="step-header">
            <span class="step-title">Select OAuth 2.0 grant type</span>
            <span class="step-selection" hidden$="[[!isSelectedType]]">[[_computeSelectedTypeLabel(grantType)]]</span>
          </span>
          <paper-ripple></paper-ripple>
        </div>
        <div class="step-content">
          <div class="line"></div>
          <iron-collapse opened="[[!isSelectedType]]" class="content">
            <div class="content">
              <paper-dropdown-menu label="Grant type" class="grant-dropdown" required="" auto-validate="">
                <paper-listbox class="dropdown-content" selected="{{grantType}}" attr-for-selected="data-type">
                  <template is="dom-repeat" items="[[grantTypes]]">
                    <paper-item data-type="[[item.type]]">[[item.label]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
            </div>
          </iron-collapse>
        </div>
      </div>

      <div class="row">
        <div class$="[[_computeStepperClass(acceptedAuthData)]]" on-tap="_openAuthDataStep">
          <span class="step">[[_computeStep(stepStartIndex, 2)]]</span>
          <span class="step-header">
            <span class="step-title">Set authorization data</span>
            <span class="step-selection" hidden$="[[!acceptedAuthData]]">Client id: <span>[[clientId]]</span></span>
          </span>
          <paper-ripple></paper-ripple>
        </div>

        <div class="step-content">
          <div class="line"></div>
          <iron-collapse opened="[[!acceptedAuthData]]" class="content">
            <div class="content">
              <paper-masked-input auto-validate="" required="" label="Client id" value="{{clientId}}" id="clientId" autocomplete="on"></paper-masked-input>
              <paper-tooltip for="clientId" position="bottom">Your client ID registered in your OAuth provider.</paper-tooltip>
              <paper-masked-input auto-validate="" required="" label="Client secret" value="{{clientSecret}}" id="clientSecret" hidden$="[[_isFieldHidden(grantType, 'client_credentials', 'authorization_code')]]" disabled$="[[_isFieldHidden(grantType, 'client_credentials', 'authorization_code')]]" autocomplete="on"></paper-masked-input>
              <paper-tooltip for="clientSecret" position="bottom">The client secret is generated by your provider unique string for your app. Check provider's console to get the code.</paper-tooltip>

              <paper-input auto-validate="" required="" label="Authorization url" value="{{authUrl}}" id="authUrl" hidden$="[[_isFieldHidden(grantType, 'implicit', 'authorization_code')]]" disabled$="[[_isFieldHidden(grantType, 'implicit', 'authorization_code')]]" type="text" autocomplete="on">
                <paper-icon-button suffix="" on-tap="_clearField" icon="arc:clear" alt="Clear input icon" title="Clear input"></paper-icon-button>
              </paper-input>
              <paper-tooltip for="authUrl" position="bottom">The authorization URL initializes the OAuth flow. If you don't know the authorization URL check your provider's documentation.</paper-tooltip>

              <paper-input auto-validate="" required="" label="Access token URL" value="{{accessTokenUrl}}" id="accessTokenUrl" hidden$="[[_isFieldHidden(grantType, 'client_credentials', 'authorization_code', 'password')]]" disabled$="[[_isFieldHidden(grantType, 'client_credentials', 'authorization_code', 'password')]]" type="text" autocomplete="on">
                <paper-icon-button suffix="" on-tap="_clearField" icon="arc:clear" alt="Clear input icon" title="Clear input"></paper-icon-button>
              </paper-input>
              <paper-tooltip for="accessTokenUrl" position="bottom">The access token URL is used by server implementations to exchange access code for access token.</paper-tooltip>

              <paper-masked-input auto-validate="" required="" label="Username" value="{{username}}" id="username" hidden$="[[_isFieldHidden(grantType, 'password')]]" disabled$="[[_isFieldHidden(grantType, 'password')]]" autocomplete="on"></paper-masked-input>
              <paper-tooltip for="username" position="bottom">The username required for this OAuth authentication.</paper-tooltip>
              <paper-masked-input auto-validate="" required="" label="Password" value="{{password}}" id="password" hidden$="[[_isFieldHidden(grantType, 'password')]]" disabled$="[[_isFieldHidden(grantType, 'password')]]" autocomplete="on"></paper-masked-input>
              <paper-tooltip for="password" position="bottom">The password required for this OAuth authentication.</paper-tooltip>

              <div hidden$="[[_isFieldHidden(grantType, 'implicit', 'authorization_code')]]">
                <oauth2-scope-selector required="" auto-validate="" allowed-scopes="[[allowedScopes]]" prevent-custom-scopes="[[preventCustomScopes]]" scopes="{{scopes}}" disabled$="[[_isFieldHidden(grantType, 'implicit', 'authorization_code')]]"></oauth2-scope-selector>
              </div>

              <div class="accept-action">
                <paper-button class="next-button" raised="" on-tap="_acceptData">Next</paper-button>
              </div>
            </div>
          </iron-collapse>
        </div>
      </div>

      <div class="row" hidden$="[[_isFieldHidden(grantType, 'implicit', 'authorization_code')]]">
        <div class="stepper">
          <span class="step">[[_computeStep(stepStartIndex, 3)]]</span>
          <span class="step-header">
            <span class="step-title">Set redirect URL in provider’s OAuth settings</span>
          </span>
        </div>
        <div class="step-content">
          <div class="line"></div>
          <div class="content">
            <div class="redirect-section">
              <p class="redirect-info">Use the following URL to set up OAuth redirect in the provider’s settings. <b>This step is required.</b></p>
              <p class="read-only-param-field padding">
                <span class="code" tabindex="0" id="redirectLabel">[[redirectUrl]]</span>
                <paper-icon-button icon="arc:content-copy" on-tap="_copyRedirectUrl" data-src="redirect" id="redirectCopyButton"></paper-icon-button>
              </p>
            </div>

            <div class="authorize-actions" hidden$="[[hasTokenValue]]">
              <paper-button disabled$="[[_authorizing]]" class="auth-button" raised="" on-tap="authorize">get access token</paper-button>
              <paper-spinner active="[[_authorizing]]"></paper-spinner>
            </div>

            <div class="current-token" hidden$="[[!hasTokenValue]]">
              <label class="token-label">Current token</label>
              <p class="token-info">The token will be set to the corresponding field (header or query parameter).</p>
              <p class="read-only-param-field no-background">
                <span class="code" tabindex="0" id="tokenLabel">[[tokenValue]]</span>
                <paper-icon-button icon="arc:content-copy" on-tap="_copyRedirectUrl" data-src="token" id="tokenCopyButton"></paper-icon-button>
              </p>
              <div class="authorize-actions">
                <paper-button disabled$="[[_authorizing]]" class="auth-button" raised="" on-tap="authorize">refresh access token</paper-button>
                <paper-spinner active="[[_authorizing]]"></paper-spinner>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
    <paper-toast text="" duration="5000"></paper-toast>
  </template>
  <script>Polymer({is:"auth-method-oauth2",behaviors:[ArcBehaviors.AuthMethodsBehavior],properties:{grantType:{type:String,value:"",notify:!0},isSelectedType:{type:Boolean,value:!1,computed:"_computeIsSelectedType(grantType)"},clientId:{type:String,notify:!0,value:""},clientSecret:{type:String,notify:!0,value:""},authUrl:{type:String,notify:!0,value:""},accessTokenUrl:{type:String,notify:!0,value:""},password:{type:String,notify:!0,value:""},username:{type:String,notify:!0,value:""},redirectUrl:String,scopes:Array,allowedScopes:Array,preventCustomScopes:Boolean,_authorizing:Boolean,tokenValue:{type:String,observer:"_tokenValueChanged",value:""},hasTokenValue:{type:Boolean,value:!1,readOnly:!0},ramlSettings:Object,acceptedAuthData:{type:Boolean,value:!1,readOnly:!0},_supportedGrantTypes:{type:Array,value:function(){return[{type:"implicit",label:"Access token (browser flow)"},{type:"authorization_code",label:"Authorization code (server flow)"},{type:"client_credentials",label:"Client credentials"},{type:"password",label:"Password"}]}},grantTypes:{type:Array},_initialized:Boolean},observers:["_settingsChanged(grantType, clientId, clientSecret, authUrl, accessTokenUrl, password, username, scopes.*, tokenValue, _initialized)","_settingsChnaged(ramlSettings.*)"],ready:function(){this._initialized=!0},attached:function(){this.listen(window,"oauth2-error","_oauth2ErrorHandler"),this.listen(window,"oauth2-token-response","_oauth2SccessHandler"),this.listen(window,"auth-settings-changed","_onAuthSettings"),this._updateGrantTypes()},detached:function(){this.unlisten(window,"oauth2-error","_oauth2ErrorHandler"),this.unlisten(window,"oauth2-token-response","_oauth2SccessHandler"),this.unlisten(window,"auth-settings-changed","_onAuthSettings")},get settings(){return this._getSettings()},validate:function(t){return t?this.$.form.checkValidity():this.$.form.validate()},_settingsChanged:function(){var t=this.$.form.validate(),e=this._getSettings(),n={settings:e,type:"oauth2",valid:t};this.fire("auth-settings-changed",n)},_clearField:function(t){t=Polymer.dom(t);for(var e,n=t.path;(e=n.shift())&&"INPUT"!==e.nodeName&&"PAPER-INPUT"!==e.nodeName;);e&&(e.value="")},_isFieldHidden:function(){var t=Array.from(arguments),e=t.splice(0,1)[0];return-1===t.indexOf(e)},authorize:function(){if(this.$.form.validate()){var t=this._getSettings();this._authorizing=!0,this.fire("oauth2-token-requested",t)}},_getSettings:function(){var t={type:this.grantType,clientId:this.clientId,tokenValue:this.tokenValue||""};switch(this.grantType){case"implicit":t.authorizationUrl=this.authUrl,t.redirectUrl=this.redirectUrl,t.scopes=this.scopes;break;case"authorization_code":t.authorizationUrl=this.authUrl,t.clientSecret=this.clientSecret,t.accessTokenUrl=this.accessTokenUrl,t.redirectUrl=this.redirectUrl,t.scopes=this.scopes;break;case"client_credentials":t.clientSecret=this.clientSecret,t.accessTokenUrl=this.accessTokenUrl;break;case"password":t.username=this.username,t.password=this.password,t.accessTokenUrl=this.accessTokenUrl}return t},_tokenValueChanged:function(t){this._authorizing=!1,t?this._setHasTokenValue(!0):this._setHasTokenValue(!1)},_oauth2ErrorHandler:function(t,e){this._authorizing=!1;var n=this.$$("paper-toast");n.text=e.message,n.opened=!0},_oauth2SccessHandler:function(t,e){e.accessToken&&e.accessToken!==this.tokenValue&&(this.set("tokenValue",e.accessToken),this.fire("oauth2-token-ready",{token:e.accessToken}))},_settingsChnaged:function(t){if(t&&t.base){var e=t.base;e&&e.settings&&this.preFill(e.settings)}},preFill:function(t){if(!t)throw new Error("The `settings` argument is not set.");if(t.authorizationGrants&&t.authorizationGrants instanceof Array&&t.authorizationGrants.length){var e=t.authorizationGrants.indexOf("code");-1!==e&&(t.authorizationGrants[e]="authorization_code"),this._updateGrantTypes(t.authorizationGrants)}else this._updateGrantTypes();t.accessTokenUri&&(this.accessTokenUrl=t.accessTokenUri),t.authorizationUri&&(this.authUrl=t.authorizationUri),t.scopes&&(this.scopes=t.scopes)},_updateGrantTypes:function(t){var e=this._supportedGrantTypes.map(function(t){return t});if(!t||!t.length)return void this.set("grantTypes",e);var n;for(n=e.length-1;n>=0;n--)-1===t.indexOf(e[n].type)&&e.splice(n,1);this.set("grantTypes",e);var i=this.grantType,r=!1;for(n=e.length-1;n>=0;n--)if(e[n].type===i){r=!0;break}r||(e&&e[0]?this.set("grantType",e[0].type):this.set("grantType",""))},_computeIsSelectedType:function(t){return!!t},_computeStepperClass:function(t){var e="stepper";return t&&(e+=" active"),e},_clearTypeSelection:function(){this.grantType=""},_computeSelectedTypeLabel:function(t){switch(t){case"implicit":return"Access token (browser flow)";case"authorization_code":return"Authorization code (server flow)";case"client_credentials":return"Client credentials";case"password":return"Password"}},_copyRedirectUrl:function(t){t=Polymer.dom(t);var e=t.localTarget.dataset.src;if(!e)throw new Error("Copy to clipboard require the data-src attribute.");var n;switch(e){case"redirect":n={container:this.$.redirectLabel,button:this.$.redirectCopyButton};break;case"token":n={container:this.$.tokenLabel,button:this.$.tokenCopyButton};break;default:throw new Error("Unknown src value")}return this._copyToClipboard(n)},_copyToClipboard:function(t){var e=document.createRange();e.selectNodeContents(t.container);var n=window.getSelection();n.removeAllRanges(),n.addRange(e);var i=!1;try{i=document.execCommand("copy"),t.button.icon="done"}catch(e){Polymer.Base._error(e),t.button.icon="error"}return setTimeout(this._resetCopyButtonState.bind(this,t.button),1e3),n.removeAllRanges(),i},_resetCopyButtonState:function(t){t.icon="content-copy"},_acceptData:function(){this.$.form.validate()&&this._setAcceptedAuthData(!0)},_openAuthDataStep:function(){this._setAcceptedAuthData(!1)},_onAuthSettings:function(t){if(this._initialized){if(Polymer.dom(t).rootTarget!==this&&"oauth2"===t.detail.type){var e=t.detail.settings;for(var n in e){var i;i="type"===n?"grantType":"authorizationUrl"===n?"authUrl":n,this[i]!==e[n]&&(this[i]=e[n])}}}}});</script>
</dom-module>
</body></html>