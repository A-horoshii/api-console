<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../raml-body-editor-panel/raml-body-editor-panel.html">
<link rel="import" href="../raml-request-headers-editor/raml-request-headers-editor.html">
<link rel="import" href="../raml-docs-response-panel/raml-docs-response-panel.html">
<link rel="import" href="../raml-docs-method-viewer/raml-docs-method-viewer.html">
<link rel="import" href="../raml-request-parameters-editor/raml-request-parameters-editor.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../raml-request-url-editor/raml-request-url-editor.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../authorization-panel/authorization-panel.html">
<link rel="import" href="../oauth-authorization/oauth2-authorization.html">
<link rel="import" href="../promise-polyfill/promise-polyfill-lite.html">
<link rel="import" href="../fetch-polyfill/fetch-polyfill.html">
<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="raml-request-panel-simple-xhr.html">

</head><body><dom-module id="raml-request-panel">
  <template>
    <style>
     :host {
      display: block;
      @apply(--raml-request-panel);
    }

    .content {
      height: 100%;
      @apply(--layout-vertical);
      @apply(--raml-request-panel-container);
    }

    h2 {
      @apply(--paper-font-subhead);
      margin: 8px 12px;
      font-weight: var(--raml-request-panel-navigation-title-font-weight, 500);
    }

    *[hidden] {
      display: none !important;
    }

    iron-pages>* {
      border: 1px var(--raml-request-panel-panel-border-color, transparent) solid;
      min-height: 120px;
    }

    .action-bar {
      @apply(--layout-horizontal);
      @apply(--layout-end-justified);
      @apply(--layout-center);
      margin-top: 8px;
    }

    .action-button {
      background-color: var(--accent-color);
      color: #fff;
      @apply(--action-button);
    }

    .url-editor {
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }

    raml-request-url-editor {
      @apply(--layout-flex);
    }

     :host([narrow]) .content {
      @apply(--layout-vertical);
      @apply(--raml-request-panel-container-narrow);
    }

     :host([narrow]) raml-request-url-editor {
      width: auto;
    }

    paper-spinner {
      margin-right: 8px;
    }

    .panel-warning {
      width: 16px;
      height: 16px;
      margin-left: 4px;
      color: #FF5722;
    }

    .auth-required-info {
      color: rgba(0, 0, 0, 0.54);
    }
    </style>
    <iron-media-query query="(max-width: [[narrowWidth]])" query-matches="{{narrow}}"></iron-media-query>
    <div class="content">
      <div class="url-editor">
        <raml-request-url-editor uri-parameters="[[method.allUriParameters]]" url="[[method.absoluteUri]]" value="{{url}}"></raml-request-url-editor>
      </div>
      <paper-tabs selected="{{selectedTab}}">
        <paper-tab hidden$="[[!authRequired]]">
          Authorization
          <iron-icon icon="arc:warning" class="panel-warning" hidden$="[[authValid]]" title="Fill up missing auth data"></iron-icon>
        </paper-tab>
        <paper-tab>Parameters</paper-tab>
        <paper-tab>Headers</paper-tab>
        <paper-tab hidden$="[[!isPayloadRequest]]">Body</paper-tab>
      </paper-tabs>
      <iron-pages selected="{{selectedTab}}">
        <authorization-panel hidden$="[[!authRequired]]" secured-by="[[method.securedBy]]" narrow="[[narrow]]" request-url="[[url]]" request-method="[[method.method]]" redirect-url="[[redirectUrl]]" is-required="{{authRequired}}"></authorization-panel>
        <raml-request-parameters-editor narrow="[[narrow]]" query-parameters="[[method.queryParameters]]" uri-parameters="[[method.allUriParameters]]" url="[[method.absoluteUri]]" value="{{url}}"></raml-request-parameters-editor>
        <raml-request-headers-editor narrow="[[narrow]]" raml-headers="[[method.headers]]" content-type="{{contentType}}" is-payload="[[isPayloadRequest]]" value="{{headers}}"></raml-request-headers-editor>
        <raml-body-editor-panel narrow="[[narrow]]" body="[[method.body]]" hidden$="[[!isPayloadRequest]]" content-type="{{contentType}}" value="{{payload}}"></raml-body-editor-panel>
      </iron-pages>
      <div class="action-bar">
        <paper-spinner alt="Loading contacts list" active="[[loadingRequest]]"></paper-spinner>
        <paper-button class="action-button" on-tap="execute" hidden$="[[authNeeded]]">Send</paper-button>
        <div hidden$="[[!authNeeded]]">
          <span class="auth-required-info">This endpoint requires authorization.</span>
          <paper-button class="action-button" on-tap="authAndExecute">authorize and send</paper-button>
        </div>
      </div>
    </div>
    <paper-dialog id="authDialog">
      <h2>Authorization</h2>
      <paper-dialog-scrollable>
        <authorization-panel secured-by="[[method.securedBy]]" narrow="[[narrow]]" request-url="[[url]]" request-method="[[method.method]]" redirect-url="[[redirectUrl]]"></authorization-panel>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss="" autofocus="">Cancel</paper-button>
        <paper-button dialog-confirm="" on-tap="_onAuthAndSend">Authorize</paper-button>
      </div>
    </paper-dialog>
    <oauth2-authorization></oauth2-authorization>
    <raml-request-panel-simple-xhr id="xhr"></raml-request-panel-simple-xhr>
    <paper-toast text="Authorization is required for this endpoint." id="authRequired"></paper-toast>
    <paper-toast text="Fill in the authorization form first." id="authFormError"></paper-toast>
  </template>
  <script>Polymer({is:"raml-request-panel",properties:{method:Object,selectedTab:{type:Number,value:0,notify:!0},contentType:{type:String,notify:!0},isPayloadRequest:{type:Boolean,value:!1,computed:"_computeIsPayloadRequest(method.*)"},headers:String,payload:String,url:String,narrow:{type:Boolean,notify:!0,reflectToAttribute:!0},narrowWidth:{type:String,value:"768px"},loadingRequest:{type:Boolean,notify:!0,readOnly:!0,value:!1},responseIsXhr:{type:Boolean,notify:!0,readOnly:!0},request:{type:Request,notify:!0,readOnly:!0},response:{type:Response,notify:!0,readOnly:!0},responseError:{type:Object,notify:!0,readOnly:!0},loadingTime:{type:Number,notify:!0,readOnly:!0},timings:{type:Object,notify:!0,readOnly:!0},redirectTimings:{type:Array,notify:!0,readOnly:!0},redirects:{type:Array,notify:!0,readOnly:!0},sourceMessage:{type:String,notify:!0,readOnly:!0},authRequired:Boolean,redirectUrl:String,authorizationMethod:String,authorizationSettings:Object,authValid:Boolean,authNeeded:{type:Boolean,value:!0,computed:"_computeAuthNeeded(authValid,authorizationMethod,authorizationSettings)"}},observers:["_isPayloadRequestChanged(isPayloadRequest)","_authRequiredChanged(authRequired)"],listeners:{"authorization-settings-changed":"_authSettingsChanged"},attached:function(){this.listen(window,"api-console-response","_responseHandler")},detached:function(){this.unlisten(window,"api-console-response","_responseHandler")},_computeIsPayloadRequest:function(e){var t=e.base;return!(!t||!t.method)&&-1===["get","head"].indexOf(t.method)},_isPayloadRequestChanged:function(e){var t=this.$$("paper-tabs");t&&(t.notifyResize(),e&&3===t.selected&&(t.selected=0))},_authRequiredChanged:function(e){var t=this.$$("paper-tabs");t&&(t.notifyResize(),e&&2===t.selected&&(t.selected=0))},execute:function(){this._clearRequestData(),this._setLoadingRequest(!0);var e=new CustomEvent("api-console-request",{cancelable:!0,bubbles:!0,composed:!0,detail:this.serializeRequest()});this.dispatchEvent(e),e.defaultPrevented||this._executeRequest(e.detail)},authAndExecute:function(){if(0===this.selectedTab)return void(this.$.authFormError.opened=!0);this.$.authDialog.opened=!0},_onAuthAndSend:function(){if(!this.authValid)return void(this.$.authRequired.opened=!0);var e=!1;switch(this.authorizationMethod){case"oauth2":this.authorizationSettings&&this.authorizationSettings.tokenValue?e=!0:this.fire("oauth2-token-requested",this.authorizationSettings);break;case"basic":if(!this.authorizationSettings||!this.authorizationSettings.hash)return void(this.$.authRequired.opened=!0);e=!0}e?this.execute():this.__pendingRequest=!0},serializeRequest:function(){return{method:this.method.method.toUpperCase(),url:this.url,headers:this.headers,payload:this.payload}},_executeRequest:function(e){this.$.xhr.execute(e)},_responseHandler:function(e){this._setResponseIsXhr(e.detail.isXhr||!0),this._setResponse(e.detail.response),this._setResponseError(e.detail.error),this._setRequest(e.detail.request),this._setLoadingTime(e.detail.loadingTime),this._setTimings(e.detail.timings),this._setRedirectTimings(e.detail.redirectTimings),this._setRedirects(e.detail.redirects),this._setSourceMessage(e.detail.sourceMessage),this.fire("api-console-response-ready",{isXhr:e.detail.isXhr,response:e.detail.response,responseError:e.detail.error,request:e.detail.request,loadingTime:e.detail.loadingTime,timings:e.detail.timings,redirectTimings:e.detail.redirectTimings,redirects:e.detail.redirects,sourceMessage:e.detail.sourceMessage}),this._setLoadingRequest(!1)},_clearRequestData:function(){this._setResponseIsXhr(!1),this._setResponse(void 0),this._setResponseError(void 0),this._setRequest(void 0),this._setLoadingTime(void 0),this._setTimings(void 0),this._setRedirectTimings(void 0),this._setRedirects(void 0)},_authSettingsChanged:function(e){this.authorizationMethod=e.detail.type,this.authorizationSettings=e.detail.settings,this.set("authValid",e.detail.valid),this.__pendingRequest&&(this.__pendingRequest=!1,this.execute())},_computeAuthNeeded:function(e,t,i){return!e||"oauth2"===t&&!i.tokenValue}});</script>
</dom-module>
</body></html>