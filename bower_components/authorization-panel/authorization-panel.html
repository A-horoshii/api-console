<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../auth-methods/auth-methods.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">

</head><body><dom-module id="authorization-panel">
  <template>
    <style>
    :host {
      display: block;
      @apply(--authorization-panel);
    }

    #container {
      position: relative;
    }

    .stepper {
      @apply(--layout-horizontal);
      @apply(--layout-center);
      padding: 12px 0;
      position: relative;
      pointer-events: none;
    }

    .stepper.active {
      pointer-events: all;
      cursor: pointer;
    }

    .step {
      display: inline-block;
      background-color: var(--stepper-step-number-background-color, #3D8099);
      color: var(--stepper-step-number-color, #fff);
      font-size: 14px;
      @apply(--layout-center-center);
      @apply(--layout-horizontal);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-right: 12px;
    }

    .step-header {
      position: relative;
    }

    .step-title {
      @apply(--arc-font-body1);
      display: block;
      color: var(--stepper-step-title-color, #3D8099);
      font-size: 16px;
      font-weight: 500;
    }

    .step-selection {
      @apply(--arc-font-body1);
      color: var(--stepper-step-selection-label-color, rgba(0, 0, 0, 0.54));
      position: absolute;
      bottom: -16px;
    }

    paper-ripple {
      color: var(--stepper-step-title-color, #3D8099);
    }

    .step-content {
      @apply(--layout-horizontal);
      margin-bottom: 12px;
      min-height: 32px;
    }

    .line {
      width: 11px;
      border-right: 1px var(--stepper-line-color, rgba(0, 0, 0, 0.12)) solid;
      margin-right: 24px;
    }
    </style>
    <div id="container">
      <div class="row">
        <div class$="[[_computeStepperClass(isSelected)]]" on-tap="_clearCelection">
          <span class="step">1</span>
          <span class="step-header">
            <span class="step-title">Select authorization method</span>
            <span class="step-selection" hidden$="[[!isSelected]]">[[_computeSelectedLabel(selected)]]</span>
          </span>
          <paper-ripple></paper-ripple>
        </div>
        <div class="step-content">
          <div class="line"></div>
          <iron-collapse opened="[[!isSelected]]">
            <div class="content">
              <paper-dropdown-menu label="Authorization method">
                <paper-listbox class="dropdown-content" selected="{{selected}}" attr-for-selected="data-type">
                  <template is="dom-repeat" items="[[authMethods]]">
                    <paper-item data-type="[[item.id]]">[[item.name]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
            </div>
          </iron-collapse>
        </div>
      </div>
      <iron-pages selected="[[selected]]" attr-for-selected="data-type" hidden$="[[!isSelected]]">
        <auth-method-basic data-type="basic"></auth-method-basic>
        <auth-method-digest data-type="digest"></auth-method-digest>
        
        <auth-method-oauth2 data-type="oauth2" redirect-url="[[redirectUrl]]" raml-settings="[[_computeSettings(securedBy, 'OAuth 2.0')]]"></auth-method-oauth2>
      </iron-pages>
    </div>
  </template>
  <script>Polymer({is:"authorization-panel",properties:{selected:{type:String,notify:!0},isSelected:{type:Boolean,value:!1,computed:"_computeIsSelected(selected)"},isRequired:{type:Boolean,value:!1,readOnly:!0,notify:!0},settings:{type:Object,readOnly:!0,notify:!0},securedBy:{type:Object,observer:"_securedByChanged"},redirectUrl:String,noRamlSelected:{type:Boolean,value:!1,readOnly:!0,notify:!0},authMethods:{type:Array},_availableAuthMethods:{type:Array,value:function(){return[{id:"basic",name:"Basic authorization"},{id:"digest",name:"Digest Authentication"},{id:"oauth2",name:"Oauth 2.0"}]}},valid:{type:Boolean,value:!0,notify:!0,computed:"_checkAuthorizationReady(settings.valid, selected, required)"}},observers:["_authSettingsChanged(selected, settings.*)","_selectedChanged(selected)"],ready:function(){this.authMethods||this.set("authMethods",this._availableAuthMethods),this._updateValidationState()},listeners:{"auth-settings-changed":"_authSettingsHandler","authorization-settings-changed":"_onAuthSettingsChanged"},_updateValidationState:function(){this.debounce("check-validation-state",function(){if(this.selected&&this.settings){var e=this.$$('[data-type="'+this.selected+'"]');if(!e)return void console.warn("The auth panel for %s not set",this.selected);this.set("settings.valid",e.validate())}},200)},_authSettingsHandler:function(e){e.detail.type===this.selected&&this._setSettings(e.detail)},_authSettingsChanged:function(e,t){if(e&&t&&t.base){var i=t.base;this._notifySettings(i,e)}},_notifySettings:function(e,t){if(!e)return this.fire("authorization-settings-changed",{settings:void 0,valid:!1,type:t});if(e.type===t)return this.fire("authorization-settings-changed",{settings:e.settings,valid:e.valid,type:this.selected})},_selectedChanged:function(e){this.fire("authorization-type-changed",{type:e});var t=this._readCurrentSettings();this._setSettings(t),this._notifySettings(t,this.selected)},_securedByChanged:function(e){if(!e||!e.length)return this._setIsRequired(!1),this._updateMethodsSelection();for(var t={oauth1:!1,oauth2:!1,basic:!1,ntlm:!1,digest:!1},i=0,a=e.length;i<a;i++)if("string"!=typeof e[i])switch(e[i].type){case"OAuth 1.0":t.oauth1=!0;break;case"OAuth 2.0":t.oauth2=!0;break;case"Basic Authentication":t.basic=!0;break;case"Digest Authentication":t.digest=!0;break;case"Pass Through":break;default:console.warn("Unsupported auth method",e[i])}this._updateMethodsSelection(t),this._updateValidationState();var s=!1;for(var n in t)if(t[n]){s=!0;break}this._setIsRequired(s)},_updateMethodsSelection:function(e){var t=this._availableAuthMethods.map(function(e){return e});if(!e)return void this.set("authMethods",t);for(var i in e)e[i]||delete e[i];var a,s=Object.keys(e);for(a=t.length-1;a>=0;a--)-1===s.indexOf(t[a].id)&&t.splice(a,1);this.set("authMethods",t);var n=this.selected,r=!1;for(a=t.length-1;a>=0;a--)if(t[a].id===n){r=!0;break}r||(t&&t[0]?this.set("selected",t[0].id):this.set("selected",""))},_computeSettings:function(e,t){if(e&&e.length&&t)for(var i=0,a=e.length;i<a;i++)if(e[i].type===t)return e[i]},_computeIsSelected:function(e){return!!e},_computeSelectedLabel:function(e){switch(e){case"basic":return"Basic";case"oauth2":return"OAuth 2.0";case"oauth1":return"OAuth 1.0";case"ntlm":return"NTLM";default:return e}},_computeStepperClass:function(e){var t="stepper";return e&&(t+=" active"),t},_clearCelection:function(){this.set("selected",void 0)},_checkAuthorizationReady:function(e,t,i){return!i||!(!t||!e)},_readCurrentSettings:function(){if(this.selected){var e=this.$$('[data-type="'+this.selected+'"]');if(!e)return void console.warn("The auth panel for %s not set",this.selected);var t=e.settings,i=e.validate();return{settings:t,type:this.selected,valid:i}}},_onAuthSettingsChanged:function(e){var t=e.detail;if(t){var i=t.type,a=this._getSecuredMethod(i);switch(i){case"basic":this._handleBasicSettings(t);break;case"oauth2":this._handleOauth2Settings(t,a);break;case"digest":this._handleDigestSettings(t);break;default:console.warn("Unsupported auth method",i)}}},_handleBasicSettings:function(e){e=e||{};var t=e.settings&&e.settings.hash?"Basic "+e.settings.hash:"";this.fire("request-header-changed",{name:"authorization",value:t})},_handleOauth2Settings:function(e,t){e=e||{},e=e.settings||{};var i=e.tokenValue,a="header",s="authorization";if(t&&t.describedBy){var n=t.describedBy;n.headers&&n.headers.length?s=n.headers[0].name:n.queryParameters&&n.queryParameters.length&&(s=n.queryParameters[0].name,a="query-parameter")}"header"===a?this.fire("request-header-changed",{name:s,value:i?"Bearer "+i:""}):"query-parameter"===a&&this.fire("query-parameter-changed",{name:s,value:i||""})},_handleDigestSettings:function(e){if(!e.valid)return this.fire("request-header-changed",{name:"authorization",value:""});if(e.settings){var t=e.settings;if(!t.username||!t.password){var i="Digest ";Object.getOwnPropertyNames(t).forEach(function(e){i+=e+'="'+t[e]+'", '}),i=i.substr(0,i.length-2),this.fire("request-header-changed",{name:"authorization",value:i})}}},_getSecuredMethod:function(e){var t=this.securedBy;if(t&&t.length)for(var i={"OAuth 1.0":"oauth1","OAuth 2.0":"oauth2","Basic Authentication":"basic","Digest Authentication":"digest","Pass Through":"passthrough"},a=0,s=t.length;a<s;a++)if(i[t[a].type]===e)return t[a]}});</script>
</dom-module>
</body></html>