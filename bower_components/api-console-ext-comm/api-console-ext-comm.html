<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../fetch-polyfill/fetch-polyfill.html">

<script>Polymer({is:"api-console-ext-comm",properties:{extension:{type:Boolean,value:!1,notify:!0,readOnly:!0},_lastestRequestData:Object},ready:function(){window.postMessage({payload:"api-console-extension-installed"},location.origin)},attached:function(){this.listen(window,"message","_messsageHandler"),this.listen(document.body,"api-console-request","_requestHandler"),this.listen(document.body,"oauth2-token-requested","_oauthTokenHandler")},detached:function(){this.unlisten(window,"message","_messsageHandler"),this.unlisten(document.body,"api-console-request","_requestHandler"),this.unlisten(document.body,"oauth2-token-requested","_oauthTokenHandler")},_messsageHandler:function(e){if(e.source===window){var t=e.data;if(t["api-console-extension"]){var s=t["api-console-payload"];switch(s){case"init":this._extensionDetected();break;case"api-console-response":this._responseReady(t["api-console-data"]);break;case"api-console-oauth2-token-response":this._oauthTokenReady(t["api-console-data"])}}}},_extensionDetected:function(){this._setExtension(!0),this.fire("api-console-extension-installed")},_requestHandler:function(e){this.extension&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this._lastestRequestData=e.detail,window.postMessage({payload:"api-console-request",detail:e.detail},location.origin))},_responseReady:function(e){var t=e?e.data.responseData:void 0,s=this._createRequest(this._lastestRequestData);this._lastestRequestData=void 0;var o=this._createResponse(t),a={request:s,response:o,loadingTime:e?e.data.stats.loadingTime:0,isXhr:!0};t.error?a.error=new Error(t.message):o.ok||(a.error=new Error("Resource is unavailable"));var n=new CustomEvent("api-console-response",{cancelable:!1,bubbles:!0,composed:!0,detail:a});this.dispatchEvent(n)},_createRequest:function(e){var t={method:e.method,mode:"cors"};return e.headers&&(t.headers=this._createHeaders(e.headers)),["GET","HEAD"].indexOf(e.method)!==-1?e.payload=void 0:e.payload&&(t.body=e.payload),new Request(e.url,t)},_createResponse:function(e){if(!e||e.error)return Response.error();if(!e.status||e.status<200)return Response.error();var t={status:e.status,statusText:e.statusText};e.headers&&(t.headers=this._createHeaders(e.headers));try{return new Response(e.response,t)}catch(e){return Response.error()}},_createHeaders:function(e){if(!e)return new Headers;var t=new Headers,s=e.split("\n").map(function(e){var t=e.split(":"),s=t[0],o=t[1];return s=s?s.trim():null,o=o?o.trim():null,s&&o?{name:s,value:o}:null}).filter(function(e){return!!e});return s.forEach(function(e){t.append(e.name,e.value)}),t},_oauthTokenHandler:function(e){this.extension&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),window.postMessage({payload:"api-console-oauth2",detail:e.detail},location.origin))},_oauthTokenReady:function(e){return e?e.error?this.fire("oauth2-error",{message:e.message||"No response has been recorded.",code:e.code||"unknown_error"}):void this.fire("oauth2-token-response",e):this.fire("oauth2-error",{message:"No response has been recorded.",code:"no_response"})}});</script>
</head><body></body></html>